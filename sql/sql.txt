-- =====================================================
-- 쇼핑몰 데이터베이스 스키마 생성
-- =====================================================
-- 이 스크립트는 쇼핑몰 시스템의 모든 테이블과 시퀀스를 생성합니다.
-- 실행 순서: 시퀀스 → 기본 테이블 → 외래키가 있는 테이블 순서로 진행됩니다.

-- 1. 시퀀스 생성
-- 각 테이블의 자동 증가 ID를 위한 시퀀스들을 생성합니다.
CREATE SEQUENCE buyer_buyer_id START WITH 1 INCREMENT BY 1 MAXVALUE 99999;
CREATE SEQUENCE seller_seller_id START WITH 1 INCREMENT BY 1 MAXVALUE 99999;
CREATE SEQUENCE product_product_id START WITH 1 INCREMENT BY 1 MAXVALUE 99999;
CREATE SEQUENCE cart_cart_id_seq START WITH 1 INCREMENT BY 1 MAXVALUE 99999;
CREATE SEQUENCE buyer_order_buyer_order_id_seq START WITH 1 INCREMENT BY 1 MAXVALUE 99999;
CREATE SEQUENCE buyer_order_order_number_seq START WITH 10000 INCREMENT BY 1 MAXVALUE 99999;
CREATE SEQUENCE order_item_order_item_id_seq START WITH 1 INCREMENT BY 1 MAXVALUE 99999;
CREATE SEQUENCE payment_payment_id_seq START WITH 1 INCREMENT BY 1 MAXVALUE 99999;

-- 2. 구매자 테이블 생성
-- 쇼핑몰을 이용하는 일반 회원들의 정보를 저장합니다.
CREATE TABLE BUYER (
   Buyer_id NUMBER(5) DEFAULT buyer_buyer_id.NEXTVAL PRIMARY KEY,        -- 구매자 고유 ID (자동 증가)
   EMAIL VARCHAR2(50) NOT NULL UNIQUE,                                    -- 이메일 (로그인 ID로 사용)
   password VARCHAR2(100) NOT NULL,                                       -- 비밀번호 (암호화 저장)
   name VARCHAR2(45) NOT NULL,                                            -- 실명
   nickname VARCHAR2(24) NOT NULL UNIQUE,                                 -- 닉네임 (중복 불가)
   tel VARCHAR2(13) NOT NULL,                                             -- 전화번호
   gender VARCHAR2(6),                                                    -- 성별 (남성/여성)
   birth DATE,                                                            -- 생년월일
   post_number NUMBER,                                                    -- 우편번호
   address VARCHAR2(200) NOT NULL,                                        -- 주소
   pic BLOB DEFAULT NULL,                                                 -- 프로필 사진
   status VARCHAR2(30) DEFAULT '활성화' CHECK (status IN ('활성화','비활성화','정지','탈퇴')), -- 계정 상태
   cdate TIMESTAMP DEFAULT SYSTIMESTAMP,                                  -- 계정 생성일
   udate TIMESTAMP DEFAULT SYSTIMESTAMP,                                  -- 정보 수정일
   withdrawn_at DATE DEFAULT NULL,                                        -- 탈퇴일
   withdrawn_reason VARCHAR2(500) DEFAULT NULL,                           -- 탈퇴 사유
   CONSTRAINT ck_gender CHECK (gender IN ('남성', '여성'))                -- 성별 제약조건
);

-- 3. 판매자 테이블 생성
-- 상품을 판매하는 판매자들의 정보를 저장합니다.
CREATE TABLE SELLER (
   seller_id NUMBER(5) DEFAULT seller_seller_id.NEXTVAL PRIMARY KEY,     -- 판매자 고유 ID (자동 증가)
   EMAIL VARCHAR2(50) NOT NULL UNIQUE,                                    -- 이메일 (로그인 ID로 사용)
   password VARCHAR2(100) NOT NULL,                                       -- 비밀번호 (암호화 저장)
   biz_reg_no VARCHAR2(30) NOT NULL,                                      -- 사업자 등록번호
   shop_name VARCHAR2(100) NOT NULL,                                      -- 상점명
   name VARCHAR2(30) NOT NULL,                                            -- 대표자명
   shop_address VARCHAR2(200) NOT NULL,                                   -- 상점 주소
   tel VARCHAR2(13) NOT NULL,                                             -- 상점 전화번호
   pic BLOB DEFAULT NULL,                                                 -- 상점 로고/사진
   post_number NUMBER,                                                    -- 우편번호
   status VARCHAR2(30) DEFAULT '활성화' CHECK (status IN ('활성화','비활성화','정지','탈퇴')), -- 계정 상태
   cdate TIMESTAMP DEFAULT SYSTIMESTAMP,                                  -- 계정 생성일
   udate TIMESTAMP DEFAULT SYSTIMESTAMP,                                  -- 정보 수정일
   withdrawn_at DATE DEFAULT NULL,                                        -- 탈퇴일
   withdrawn_reason VARCHAR2(500) DEFAULT NULL,                           -- 탈퇴 사유
   CONSTRAINT uq_seller UNIQUE (biz_reg_no, status)                      -- 사업자번호와 상태의 복합 유니크 제약
);

-- 4. 상품 테이블 생성
-- 판매자가 등록하는 상품 정보를 저장합니다.
CREATE TABLE PRODUCT (
  product_id NUMBER(5) DEFAULT product_product_id.NEXTVAL PRIMARY KEY,   -- 상품 고유 ID (자동 증가)
  seller_id NUMBER(5) NOT NULL,                                          -- 판매자 ID (외래키)
  product_name VARCHAR2(200) NOT NULL,                                    -- 상품명
  title VARCHAR2(200) NOT NULL,                                          -- 상품 제목
  delivery_fee NUMBER(5) NOT NULL,                                       -- 배송비
  delivery_information VARCHAR2(200) NOT NULL,                           -- 배송 안내사항
  delivery_METHOD VARCHAR(30) NOT NULL,                                  -- 배송 방법
  Country_of_origin VARCHAR2(60) NOT NULL,                               -- 원산지
  content CLOB NOT NULL,                                                 -- 상품 상세 설명
  price NUMBER(10) NOT NULL,                                             -- 상품 가격
  quantity NUMBER(10) NOT NULL,                                          -- 재고 수량
  thumbnail VARCHAR2(255) DEFAULT NULL,                                  -- 상품 썸네일 이미지 경로
  status VARCHAR2(20) DEFAULT '판매중' CHECK (status IN ('판매중','재고소진','비활성화')), -- 판매 상태
  cdate TIMESTAMP DEFAULT SYSTIMESTAMP,                                  -- 상품 등록일
  udate TIMESTAMP DEFAULT SYSTIMESTAMP,                                  -- 상품 수정일
  CONSTRAINT fk_post_seller FOREIGN KEY (seller_id) REFERENCES seller(seller_id) -- 판매자 외래키
);

-- 5. 장바구니 테이블 생성
-- 구매자가 상품을 장바구니에 담아두는 정보를 저장합니다.
CREATE TABLE CART (
    cart_id NUMBER(5) DEFAULT cart_cart_id_seq.NEXTVAL PRIMARY KEY,      -- 장바구니 항목 고유 ID
    buyer_id NUMBER(5) NOT NULL,                                         -- 구매자 ID (외래키)
    product_id NUMBER(5) NOT NULL,                                       -- 상품 ID (외래키)
    quantity NUMBER(5) NOT NULL,                                         -- 담은 수량
    added_at TIMESTAMP DEFAULT SYSTIMESTAMP,                             -- 장바구니 담은 시간
    is_checked CHAR(1) DEFAULT 'N' CHECK (is_checked IN ('Y', 'N')),     -- 주문 선택 여부 (Y: 선택, N: 미선택)
    CONSTRAINT fk_cart_buyer FOREIGN KEY (buyer_id) REFERENCES buyer(buyer_id),     -- 구매자 외래키
    CONSTRAINT fk_cart_product FOREIGN KEY (product_id) REFERENCES product(product_id), -- 상품 외래키
    CONSTRAINT uq_cart UNIQUE (buyer_id, product_id)                     -- 동일 구매자의 동일 상품 중복 방지
);

-- 6. 주문 테이블 생성
-- 구매자가 상품을 주문한 정보를 저장합니다.
CREATE TABLE BUYER_ORDER (
    order_id NUMBER(5) DEFAULT buyer_order_buyer_order_id_seq.NEXTVAL PRIMARY KEY, -- 주문 고유 ID (내부 관리용)
    buyer_id NUMBER(5) NOT NULL,                                         -- 구매자 ID (외래키)
    order_number NUMBER(5) DEFAULT buyer_order_order_number_seq.NEXTVAL NOT NULL UNIQUE, -- 주문번호 (고객에게 보여줄 번호)
    name VARCHAR2(30) NOT NULL,                                          -- 수령자명
    tel VARCHAR2(13) NOT NULL,                                           -- 수령자 전화번호
    delivery_address VARCHAR2(200) NOT NULL,                             -- 배송지 주소
    order_date DATE DEFAULT SYSTIMESTAMP NOT NULL,                       -- 주문일
    order_status VARCHAR2(15) CHECK (order_status IN ('결제실패','결제완료','배송중','배송완료','주문취소')) NOT NULL, -- 주문 상태
    CONSTRAINT fk_buyer_order_buyer FOREIGN KEY (buyer_id) REFERENCES buyer(buyer_id) -- 구매자 외래키
);

-- 7. 주문 상품 테이블 생성
-- 주문에 포함된 개별 상품들의 정보를 저장합니다.
CREATE TABLE ORDER_ITEM (
   order_item_id NUMBER(5) DEFAULT order_item_order_item_id_seq.NEXTVAL PRIMARY KEY, -- 주문상품 고유 ID
   order_id NUMBER(5) NOT NULL,                                          -- 주문 ID (외래키)
   product_id NUMBER(5) NOT NULL,                                        -- 상품 ID (외래키)
   quantity NUMBER(5) NOT NULL,                                          -- 주문 수량
   UNIT_price NUMBER(10) NOT NULL,                                       -- 주문 당시 단가
   total_price NUMBER(15) NOT NULL,                                      -- 해당 상품 총 금액 (단가 * 수량)
   delivery_company VARCHAR2(45) DEFAULT NULL,                           -- 배송업체명
   tracking_number VARCHAR2(50) DEFAULT NULL,                            -- 운송장 번호
   CONSTRAINT fk_member_order_member_order_id FOREIGN KEY (order_id) REFERENCES buyer_order(order_id), -- 주문 외래키
   CONSTRAINT fk_product_product_id FOREIGN KEY (product_id) REFERENCES product(product_id) -- 상품 외래키
);

-- 8. 결제 테이블 생성
-- 주문에 대한 결제 정보를 저장합니다.
CREATE TABLE PAYMENT (
    payment_id NUMBER(5) DEFAULT payment_payment_id_seq.NEXTVAL PRIMARY KEY, -- 결제 고유 ID
    order_id NUMBER(5) NOT NULL,                                         -- 주문 ID (외래키)
    payment_status VARCHAR2(15) CHECK (payment_status IN ('성공', '실패')), -- 결제 상태
    amount NUMBER(15) NOT NULL,                                          -- 결제 금액
    paid_at DATE DEFAULT SYSTIMESTAMP,                                   -- 결제 완료일
    CONSTRAINT fk_payment_member_order_id FOREIGN KEY (order_id) REFERENCES buyer_order(order_id) -- 주문 외래키
);

-- 9. 리뷰 테이블 생성
CREATE SEQUENCE review_review_id_seq START WITH 1 INCREMENT BY 1 MAXVALUE 99999;
CREATE TABLE review (
   review_id NUMBER(5) DEFAULT review_review_id_seq.nextval,
   buyer_id NUMBER(5),
   order_id NUMBER(5),
   order_item_id NUMBER(5),
   product_id number(5),
   title varchar2(100),
   content clob,
   pic blob,
   score NUMBER(1),
   cdate DATE DEFAULT sysdate ,
   udate DATE DEFAULT sysdate,
   CONSTRAINT fk_buyer_id FOREIGN KEY (buyer_id) REFERENCES buyer(buyer_id),
   CONSTRAINT fk_order_id FOREIGN KEY (order_id) REFERENCES buyer_order(order_id),
   CONSTRAINT fk_order_item_id FOREIGN KEY (order_item_id) REFERENCES order_item(order_item_id),
   CONSTRAINT fk_product_id FOREIGN KEY (product_id) REFERENCES product(product_id),
   CONSTRAINT uk_review UNIQUE (buyer_id,order_id,order_item_id)
);

-- =====================================================
-- 테이블 생성 완료
-- =====================================================

COMMIT;

-- =====================================================
-- 테스트 데이터 삽입
-- =====================================================

-- 판매자 테스트 데이터 (product 테이블에 필요한 seller_id를 위해)
INSERT INTO SELLER (EMAIL, password, biz_reg_no, shop_name, name, shop_address, tel) 
VALUES ('seller1@test.com', 'password123', '1234567890', '테스트상점1', '김판매', '서울시 강남구 테스트로 123', '02-1234-5678');

INSERT INTO SELLER (EMAIL, password, biz_reg_no, shop_name, name, shop_address, tel) 
VALUES ('seller2@test.com', 'password123', '2345678901', '테스트상점2', '이판매', '서울시 서초구 테스트로 456', '02-2345-6789');

-- 구매자 테스트 데이터 5개
INSERT INTO BUYER (EMAIL, password, name, nickname, tel, gender, birth, post_number, address, status) 
VALUES ('buyer1@test.com', 'password123', '김구매', '구매자1', '010-1234-5678', '남성', TO_DATE('1990-01-15', 'YYYY-MM-DD'), 12345, '서울시 강남구 테스트로 123', '활성화');

INSERT INTO BUYER (EMAIL, password, name, nickname, tel, gender, birth, post_number, address, status) 
VALUES ('buyer2@test.com', 'password123', '이구매', '구매자2', '010-2345-6789', '여성', TO_DATE('1992-03-20', 'YYYY-MM-DD'), 23456, '서울시 서초구 테스트로 456', '활성화');

INSERT INTO BUYER (EMAIL, password, name, nickname, tel, gender, birth, post_number, address, status) 
VALUES ('buyer3@test.com', 'password123', '박구매', '구매자3', '010-3456-7890', '남성', TO_DATE('1988-07-10', 'YYYY-MM-DD'), 34567, '서울시 마포구 테스트로 789', '활성화');

INSERT INTO BUYER (EMAIL, password, name, nickname, tel, gender, birth, post_number, address, status) 
VALUES ('buyer4@test.com', 'password123', '최구매', '구매자4', '010-4567-8901', '여성', TO_DATE('1995-11-25', 'YYYY-MM-DD'), 45678, '서울시 송파구 테스트로 101', '활성화');

INSERT INTO BUYER (EMAIL, password, name, nickname, tel, gender, birth, post_number, address, status) 
VALUES ('buyer5@test.com', 'password123', '정구매', '구매자5', '010-5678-9012', '남성', TO_DATE('1993-09-05', 'YYYY-MM-DD'), 56789, '서울시 영등포구 테스트로 202', '활성화');

COMMIT;

-- =====================================================
-- 테이블 삭제 스크립트 (필요시 사용)
-- =====================================================
-- 주의: 외래키 제약조건으로 인해 삭제 순서를 지켜야 합니다.
-- 실행 순서: PAYMENT → ORDER_ITEM → BUYER_ORDER → CART → PRODUCT → SELLER → BUYER

/*
-- 결제 테이블 삭제
DROP TABLE PAYMENT CASCADE CONSTRAINTS;

-- 주문 상품 테이블 삭제
DROP TABLE ORDER_ITEM CASCADE CONSTRAINTS;

-- 주문 테이블 삭제
DROP TABLE BUYER_ORDER CASCADE CONSTRAINTS;

-- 장바구니 테이블 삭제
DROP TABLE CART CASCADE CONSTRAINTS;

-- 상품 테이블 삭제
DROP TABLE PRODUCT CASCADE CONSTRAINTS;

-- 판매자 테이블 삭제
DROP TABLE SELLER CASCADE CONSTRAINTS;

-- 구매자 테이블 삭제
DROP TABLE BUYER CASCADE CONSTRAINTS;

-- 시퀀스 삭제
DROP SEQUENCE buyer_buyer_id;
DROP SEQUENCE seller_seller_id;
DROP SEQUENCE product_product_id;
DROP SEQUENCE cart_cart_id_seq;
DROP SEQUENCE buyer_order_buyer_order_id_seq;
DROP SEQUENCE buyer_order_order_number_seq;
DROP SEQUENCE order_item_order_item_id_seq;
DROP SEQUENCE payment_payment_id_seq;

COMMIT;
*/