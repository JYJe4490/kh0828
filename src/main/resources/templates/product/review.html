<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>리뷰 관리</title>
  <!-- 필요 시 컨텍스트 경로/CSRF 메타 주입
  <meta name="ctx" th:content="${#httpServletRequest.contextPath}">
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}"> -->
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px; }
    .row { display: flex; gap: 24px; align-items: flex-start; }
    form, .panel { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    form { width: 420px; }
    .panel { flex: 1; }
    label { display: block; font-size: 12px; color: #374151; margin-top: 10px; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 8px; }
    textarea { min-height: 96px; resize: vertical; }
    .actions { margin-top: 14px; display: flex; gap: 8px; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #111827; color: #fff; cursor: pointer; }
    button.secondary { background: #fff; color: #111827; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    th, td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: top; }
    tr:hover { background: #fafafa; }
    .muted { color: #6b7280; font-size: 12px; }
    .tag { font-size: 12px; border: 1px solid #d1d5db; padding: 2px 6px; border-radius: 999px; }
  </style>
</head>
<body>
<h1>리뷰 관리</h1>

<div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap;">
  <div style="display:flex;align-items:center;gap:8px;">
    <label for="productId" style="margin:0">상품 ID:</label>
    <input id="productId" type="number" placeholder="예) 123" />
    <button id="btnLoad" class="secondary">불러오기</button>
  </div>
  <div class="muted">URL에 <code>?productId=123</code>로 접속하면 자동 로드</div>
</div>

<div class="row">
  <form id="reviewForm">
    <h3 id="formTitle">리뷰 등록</h3>
    <input type="hidden" id="reviewId" />

    <label>상품 ID (productId)</label>
    <input type="number" id="formProductId" placeholder="상단과 동일하게" />

    <label>구매자 ID (buyerId)</label>
    <input type="number" id="buyerId" required />

    <label>주문 ID (orderId)</label>
    <input type="number" id="orderId" required />

    <label>주문 아이템 ID (orderItemId)</label>
    <input type="number" id="orderItemId" required />

    <label>제목 (title)</label>
    <input type="text" id="title" maxlength="200" required />

    <label>내용 (content)</label>
    <textarea id="content" maxlength="2000" required></textarea>

    <label>평점 (score)</label>
    <input type="number" id="score" min="0" step="1" />

    <label>사진 (pic) — 파일 선택 시 Base64로 전송</label>
    <input type="file" id="pic" accept="image/*" />

    <div class="actions">
      <button type="submit">저장</button>
      <button type="button" class="secondary" id="btnReset">초기화</button>
    </div>
    <div id="formMsg" class="muted"></div>
  </form>

  <div class="panel">
    <div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;">
      <strong>리뷰 목록</strong>
      <span id="count" class="tag">0개</span>
    </div>
    <table>
      <thead>
      <tr>
        <th>ID</th>
        <th>상품ID</th>
        <th>제목 / 내용</th>
        <th>평점</th>
        <th>작성</th>
        <th>액션</th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="listMsg" class="muted"></div>
  </div>
</div>

<script>
  function ctx() {
    const m = document.querySelector('meta[name="ctx"]');
    return m ? (m.getAttribute('content') || '') : '';
  }

  const API = {
    list: (productId) => `${ctx()}/api/review/All?productId=${encodeURIComponent(productId)}`,
    save: () => `${ctx()}/api/review/save`,
    one: (id) => `${ctx()}/api/review/one?reviewId=${encodeURIComponent(id)}`,
    update: (id) => `${ctx()}/api/review/${encodeURIComponent(id)}`,
    remove: (id) => `${ctx()}/api/review/${encodeURIComponent(id)}`,
  };

  function csrfHeaders() {
    const tokenEl = document.querySelector('meta[name="_csrf"]');
    const headerEl = document.querySelector('meta[name="_csrf_header"]');
    if (!tokenEl || !headerEl) return {};
    const token = tokenEl.getAttribute('content') || '';
    const header = headerEl.getAttribute('content') || '';
    if (!token || !header) return {};
    return { [header]: token };
  }

  function getQS(name) { return new URL(location.href).searchParams.get(name); }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function loadList() {
    const productInput = document.getElementById('productId');
    const productId = productInput.value;
    if (!productId) {
      document.getElementById('listMsg').textContent = '상품 ID를 입력하세요.';
      document.getElementById('tbody').innerHTML = '';
      document.getElementById('count').textContent = '0개';
      return;
    }
    document.getElementById('listMsg').textContent = '로딩 중...';
    try {
      const res = await fetch(API.list(productId));
      const body = await res.json();
      const rows = body?.data ?? [];
      renderList(rows);
      document.getElementById('listMsg').textContent = rows.length ? '' : '데이터가 없습니다.';
    } catch (e) {
      console.error(e);
      document.getElementById('listMsg').textContent = '목록 조회 실패';
    }
  }

  function renderList(rows) {
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    document.getElementById('count').textContent = `${rows.length}개`;
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.reviewId}</td>
        <td>${r.productId ?? '-'}</td>
        <td><strong>${escapeHtml(r.title || '')}</strong><br/><span class="muted">${escapeHtml(r.content || '')}</span></td>
        <td>${r.score ?? '-'}</td>
        <td class="muted">${r.cdate ? new Date(r.cdate).toLocaleString() : '-'}</td>
        <td>
          <button class="secondary" data-edit="${r.reviewId}">수정</button>
          <button data-del="${r.reviewId}">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
  }

  async function loadOneToForm(id) {
    try {
      const res = await fetch(API.one(id));
      const { data } = await res.json();
      if (!data) return;
      document.getElementById('reviewId').value = data.reviewId;
      document.getElementById('formProductId').value = data.productId ?? '';
      document.getElementById('buyerId').value = data.buyerId ?? '';
      document.getElementById('orderId').value = data.orderId ?? '';
      document.getElementById('orderItemId').value = data.orderItemId ?? '';
      document.getElementById('title').value = data.title ?? '';
      document.getElementById('content').value = data.content ?? '';
      document.getElementById('score').value = data.score ?? '';
      document.getElementById('pic').value = '';
      document.getElementById('formTitle').textContent = `리뷰 수정 #${data.reviewId}`;
      document.getElementById('formMsg').textContent = '';

      // 상단 productId 입력이 비어있다면 폼의 productId로 채움(편의)
      const topPid = document.getElementById('productId').value;
      if (!topPid && data.productId) {
        document.getElementById('productId').value = data.productId;
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function submitForm(e) {
    e.preventDefault();
    const topPid = document.getElementById('productId').value;
    const formPid = document.getElementById('formProductId').value;
    const productId = formPid || topPid; // 폼에 값이 있으면 우선

    const reviewId = document.getElementById('reviewId').value;
    const buyerId = Number(document.getElementById('buyerId').value);
    const orderId = Number(document.getElementById('orderId').value);
    const orderItemId = Number(document.getElementById('orderItemId').value);
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    const scoreVal = document.getElementById('score').value;
    const score = scoreVal === '' ? null : Number(scoreVal);

    const file = document.getElementById('pic').files[0];
    let base64 = null;
    if (file) base64 = await toBase64(file);

    if (!productId) {
      document.getElementById('formMsg').textContent = 'productId가 필요합니다.';
      return;
    }

    const isUpdate = !!reviewId;

    if (isUpdate) {
      // PATCH /api/review/{id}
      const payload = { title, content, pic: base64 ? base64 : null, score };
      const res = await fetch(API.update(reviewId), {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
        body: JSON.stringify(payload)
      });
      const body = await res.json();
      if (body.code === 'S-0000') {
        document.getElementById('formMsg').textContent = '수정 완료';
        resetForm(false);
        await loadList();
      } else {
        document.getElementById('formMsg').textContent = '수정 실패';
      }
    } else {
      // POST /api/review/save
      const payload = { productId: Number(productId), buyerId, orderId, orderItemId, title, content, pic: base64 ? base64 : null, score };
      const res = await fetch(API.save(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
        body: JSON.stringify(payload)
      });
      const body = await res.json();
      if (body.code === 'S-0000') {
        document.getElementById('formMsg').textContent = `등록 완료 (#${body.data})`;
        resetForm();
        await loadList();
      } else {
        document.getElementById('formMsg').textContent = '등록 실패';
      }
    }
  }

  async function onTableClick(e) {
    const editId = e.target.getAttribute('data-edit');
    const delId = e.target.getAttribute('data-del');
    if (editId) {
      await loadOneToForm(editId);
    }
    if (delId) {
      if (!confirm(`리뷰 #${delId} 삭제할까요?`)) return;
      const res = await fetch(API.remove(delId), { method: 'DELETE', headers: csrfHeaders() });
      const body = await res.json();
      if (body.code === 'S-0000') {
        await loadList();
      } else {
        alert('삭제 실패');
      }
    }
  }

  function resetForm(clearPid = true) {
    document.getElementById('reviewId').value = '';
    if (clearPid) {
      document.getElementById('productId').value = '';
      document.getElementById('formProductId').value = '';
    }
    document.getElementById('buyerId').value = '';
    document.getElementById('orderId').value = '';
    document.getElementById('orderItemId').value = '';
    document.getElementById('title').value = '';
    document.getElementById('content').value = '';
    document.getElementById('score').value = '';
    document.getElementById('pic').value = '';
    document.getElementById('formTitle').textContent = '리뷰 등록';
    document.getElementById('formMsg').textContent = '';
  }

  document.getElementById('btnLoad').addEventListener('click', loadList);
  document.getElementById('tbody').addEventListener('click', onTableClick);
  document.getElementById('btnReset').addEventListener('click', () => resetForm(false));
  document.getElementById('reviewForm').addEventListener('submit', submitForm);

  (function init() {
    const pid = getQS('productId');
    if (pid) {
      document.getElementById('productId').value = pid;
      document.getElementById('formProductId').value = pid;
      loadList();
    }
  })();
</script>
</body>
</html>